---
# Source: gx-registry/templates/deployment-registry.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gx-registry
  namespace: infra
  labels:
    app.kubernetes.io/name: gx-registry
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: gx-registry
  template:
    metadata:
      annotations:
        randstring: "AZtvXjSD"
      labels:
        app.kubernetes.io/name: gx-registry
    spec:
      securityContext:
        fsGroup: 1000
      initContainers:
        - name: wait-for-kubo
          image: busybox
          command:
            - sh
            - -c
            - until nc -z gx-registry-kubo 5001; do echo waiting for Kubo; sleep 2; done;
        - name: local-trust
          image: quay.io/wi_stefan/gaiax-local-trust:0.0.1
          imagePullPolicy: Always
          env:
            - name: ROOT_CA
              value: "MIIFnDCCA4SgAwIBAgIBATANBgkqhkiG9w0BAQsFADBnMQswCQYDVQQGEwJERTEPMA0GA1UECAwGU2F4b255MRAwDgYDVQQHDAdEcmVzZGVuMRMwEQYDVQQKDApGSUNPREVTIENBMRMwEQYDVQQDDApGSUNPREVTLUNBMQswCQYDVQQFEwIwMTAeFw0yNTAzMDMxNDQ4MTRaFw0zNTAzMDExNDQ4MTRaMGcxCzAJBgNVBAYTAkRFMQ8wDQYDVQQIDAZTYXhvbnkxEDAOBgNVBAcMB0RyZXNkZW4xEzARBgNVBAoMCkZJQ09ERVMgQ0ExEzARBgNVBAMMCkZJQ09ERVMtQ0ExCzAJBgNVBAUTAjAxMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEApe8+9e1GMHhHzw1fDqqS5zVOGs/wfmc9V7fvfmfI/yDbc6+4+M2wOlbYJJldKpP9TdT1wakztMqvFvmXOqAeh9YShB7/V1XY4RjpjX0ofKxNyGnahtSRzu3Voaermh1IgNULFONitGxQEuYRFOUFr5g8RogTfS2ybDeCfhRGWEFGUnG2TkiruzMayvQjEOioKMZMvVKQ4w0S03kLdORe2KXuTQVT3OIxOB9mgdcDORbm7Hy9/BkAkuOg+ARyFUtaNrjkaP9+1Ya+2xFzFR0XVYe4hZA2+iLsnM7X5BTzBq3Xav3NpMCkpg5jf/bZ1wypqf5bmyhhdq9vvSyP0SQpQfbu7JJFOpI/7ouI2EtwvbK/FelMePOYR0WntVN+PBW46qzwQY8EavBQ12To2sQRBD5KBYfG2A9VCHQhrKQ4ZvpetlxlPNYlyzUrEOh4Djgb0Vsni4FAMrUFqL2s/Wn2wL6Di4I57Yju5f3RjR3QrymSBoerUthYQnvMYZ/1TelVqaoa41ZuYIkiXI5oTMWQj23vfPVoAztRCNEtEhL+xeNHpIlFJdDHh0Uhyb6GNBfV9w+JuPmcm+vYybP1S2Ss7QFBGr/aJ8CgfMmT1ufqb891IdhgOlaqOBfenl2YAz1FLoqLbkJktHkIEgcQ+gX7/xlG0w2LunnXZBOfDO0/6PECAwEAAaNTMFEwHQYDVR0OBBYEFHaTXoSXDIbLD+LecRE8bA0hA7BqMB8GA1UdIwQYMBaAFHaTXoSXDIbLD+LecRE8bA0hA7BqMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggIBAGeZ0khTzgSnttOSOwfmtqSpcWBV+trSGwVXqXkTbUohH8i/7KaR0rRkX4DTMnioIb0PWJ6pEaf1wzBcYhdLLm9QPJvaUovdfe9ga4F3Pa5u7Dp4m9A16qtfgEaoQDepYvKuRpUMnoP7h94yg5aeqc2D9N6rpicwrgOUYySe8UhN+SQ8s3E+v02nwjvGDq7ToDU1p14tedUbPvQyqDZo/EuhARXbuMWRTgP1AfGWCETO2HBaUHZIZdV//djTWvnaNjjlRHq5i6tLbAvU82Z2Oy0brc2pHD77sOpsoEAI5C0M3k7bACAkb6qQ0gQLdKwvzdhTbj0kiu+c+PPwltr+JQ8WfoiCh/ufJtxnkYX4D+Vn6LkJJAaQP9WF1TuEkT6wmi3p85Cpt6MAA/YmBQP55cBNJcqJrxrkSHkgg5bdoPQwY5AodtCjkzofwO7naEO6HvN2goFWpoWGF1IYHHAUaWvZNBYCIPmreTKrWMa9KbrA3WZ9/nwEo0WMh8gwE2FPMjx8JE+6TzsQ8ts/8KiK2YyjV8eXjt6QsglZrfMUIystRZ/vi3wbi2ARtg1B38dbZIiXLkcCq9sqdI+Rd5JDe/hX7L5NYHec0nBi4/6TRRAx8GFEqJcALjaaJ3XNFf5gh8bUM26S1f9ndz9/K7DvtDkgs/CK8cF4Xef56BNudTQE"
          volumeMounts:
            - name: trust-anchor
              mountPath: /out
      containers:
        - name: gx-registry
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
          image: "registry.gitlab.com/gaia-x/lab/compliance/gx-registry:v2.8.1"
          imagePullPolicy: Always
          env:
            - name: PORT
              value: "3000"
            - name: BASE_URI
              value: "https://registry.127.0.0.1.nip.io/v2"
            - name: BASE_URL
              value: "https://registry.127.0.0.1.nip.io/v2"
            - name: APP_PATH
              value: "/v2"
            - name: evsslonly
              value: "false"
            - name: revocationListURL
              value:
            - name: trustedIssuersURL
              value:
            - name: KUBO_HOST
              value: gx-registry-kubo
            - name: APP_BRANCH
              value: "main"
            - name: ONTOLOGY_VERSION
              value: "development"
            - name: PRIVATE_KEY_ALGORITHM
              value: "PS256"
            - name: NODE_TLS_REJECT_UNAUTHORIZED
              value: "0"
            - name: HTTPS_PROXY
              value: "http://squid-proxy.infra.svc.cluster.local:8888"
            - name: HTTP_PROXY
              value: "http://squid-proxy.infra.svc.cluster.local:8888"
          envFrom:
            - secretRef:
                name: gx-registry-keypair
          volumeMounts:
            - name: registry-ipfs-data
              mountPath: /data/ipfs
            - name: trust-anchor
              mountPath: /data/ipfs/registry/
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          livenessProbe:
            periodSeconds: 15
            initialDelaySeconds: 15
            failureThreshold: 10
            successThreshold: 1
            httpGet:
              path: /v2
              port: 3000
          readinessProbe:
            periodSeconds: 15
            initialDelaySeconds: 15
            failureThreshold: 10
            successThreshold: 1
            httpGet:
              path: /v2
              port: 3000
          resources: {}
      volumes:
        - name: trust-anchor
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: registry-ipfs-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: "500Mi"
        storageClassName: "local-path"
